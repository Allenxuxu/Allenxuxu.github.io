<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>protobuf on 徐旭 的博客</title><link>https://blog.iofree.xyz/tags/protobuf/</link><description>Recent content in protobuf on 徐旭 的博客</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Tue, 02 Jun 2020 11:22:38 +0800</lastBuildDate><atom:link href="https://blog.iofree.xyz/tags/protobuf/index.xml" rel="self" type="application/rss+xml"/><item><title>golang protobuf 字段为零值时 json 序列化忽略问题</title><link>https://blog.iofree.xyz/posts/practice/protobuf-json/</link><pubDate>Tue, 02 Jun 2020 11:22:38 +0800</pubDate><guid>https://blog.iofree.xyz/posts/practice/protobuf-json/</guid><description>protoc 编译生成的 pb.go 文件，默认情况下 tag 中会设置 json 忽略零值的返回属性 omitempty。
type Message struct { Header map[string]string `protobuf:&amp;#34;bytes,1,rep,name=header,proto3&amp;#34; json:&amp;#34;header,omitempty&amp;#34; protobuf_key:&amp;#34;bytes,1,opt,name=key,proto3&amp;#34; protobuf_val:&amp;#34;bytes,2,opt,name=value,proto3&amp;#34;` Body []byte `protobuf:&amp;#34;bytes,2,opt,name=body,proto3&amp;#34; json:&amp;#34;body,omitempty&amp;#34;` XXX_NoUnkeyedLiteral struct{} `json:&amp;#34;-&amp;#34;` XXX_unrecognized []byte `json:&amp;#34;-&amp;#34;` XXX_sizecache int32 `json:&amp;#34;-&amp;#34;` } 一个比较 hack 的方式，是在 pb.go 文件生成后，手动去删掉 omitempty 。每次手动去删除，比较麻烦且容易出错，下面提供一个 Makefile ，每次生成 pb.go 的时候就去删除 omitempty 。
proto: protoc --proto_path=. --go_out=. --micro_out=. config/config.proto ls config/*.pb.go | xargs -n1 -IX bash -c &amp;#39;sed s/,omitempty// X &amp;gt; X.tmp &amp;amp;&amp;amp; mv X{.tmp,}&amp;#39; proto 目标的第一个命令是调用 protoc 根据 config/config.</description></item></channel></rss>