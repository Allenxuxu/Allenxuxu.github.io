<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>protobuf on 顾惜朝 的博客</title><link>https://blog.iofree.xyz/tags/protobuf/</link><description>Recent content in protobuf on 顾惜朝 的博客</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Tue, 02 Jun 2020 11:22:38 +0800</lastBuildDate><atom:link href="https://blog.iofree.xyz/tags/protobuf/index.xml" rel="self" type="application/rss+xml"/><item><title>golang protobuf 字段为零值时 json 序列化忽略问题</title><link>https://blog.iofree.xyz/posts/practice/protobuf-json/</link><pubDate>Tue, 02 Jun 2020 11:22:38 +0800</pubDate><guid>https://blog.iofree.xyz/posts/practice/protobuf-json/</guid><description>&amp;lt;p&amp;gt;protoc 编译生成的 pb.go 文件，默认情况下 tag 中会设置 json 忽略零值的返回属性 &amp;lt;code&amp;gt;omitempty&amp;lt;/code&amp;gt;。&amp;lt;/p&amp;gt;
&amp;lt;div class=&amp;#34;highlight&amp;#34;&amp;gt;&amp;lt;pre style=&amp;#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&amp;#34;&amp;gt;&amp;lt;code class=&amp;#34;language-go&amp;#34; data-lang=&amp;#34;go&amp;#34;&amp;gt;&amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;type&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;Message&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;struct&amp;lt;/span&amp;gt; {
&amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;Header&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;map&amp;lt;/span&amp;gt;[&amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;string&amp;lt;/span&amp;gt;]&amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;string&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#e6db74&amp;#34;&amp;gt;`protobuf:&amp;amp;#34;bytes,1,rep,name=header,proto3&amp;amp;#34; json:&amp;amp;#34;header,omitempty&amp;amp;#34; protobuf_key:&amp;amp;#34;bytes,1,opt,name=key,proto3&amp;amp;#34; protobuf_val:&amp;amp;#34;bytes,2,opt,name=value,proto3&amp;amp;#34;`&amp;lt;/span&amp;gt;
&amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;Body&amp;lt;/span&amp;gt; []&amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;byte&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#e6db74&amp;#34;&amp;gt;`protobuf:&amp;amp;#34;bytes,2,opt,name=body,proto3&amp;amp;#34; json:&amp;amp;#34;body,omitempty&amp;amp;#34;`&amp;lt;/span&amp;gt;
&amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;XXX_NoUnkeyedLiteral&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;struct&amp;lt;/span&amp;gt;{} &amp;lt;span style=&amp;#34;color:#e6db74&amp;#34;&amp;gt;`json:&amp;amp;#34;-&amp;amp;#34;`&amp;lt;/span&amp;gt;
&amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;XXX_unrecognized&amp;lt;/span&amp;gt; []&amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;byte&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#e6db74&amp;#34;&amp;gt;`json:&amp;amp;#34;-&amp;amp;#34;`&amp;lt;/span&amp;gt;
&amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;XXX_sizecache&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;int32&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#e6db74&amp;#34;&amp;gt;`json:&amp;amp;#34;-&amp;amp;#34;`&amp;lt;/span&amp;gt;
}
&amp;lt;/code&amp;gt;&amp;lt;/pre&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;p&amp;gt;一个比较 hack 的方式，是在 pb.go 文件生成后，手动去删掉 &amp;lt;code&amp;gt;omitempty&amp;lt;/code&amp;gt; 。每次手动去删除，比较麻烦且容易出错，下面提供一个 Makefile ，每次生成 pb.go 的时候就去删除 &amp;lt;code&amp;gt;omitempty&amp;lt;/code&amp;gt; 。&amp;lt;/p&amp;gt;
&amp;lt;div class=&amp;#34;highlight&amp;#34;&amp;gt;&amp;lt;pre style=&amp;#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&amp;#34;&amp;gt;&amp;lt;code class=&amp;#34;language-makefile&amp;#34; data-lang=&amp;#34;makefile&amp;#34;&amp;gt;&amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;proto&amp;lt;/span&amp;gt;&amp;lt;span style=&amp;#34;color:#f92672&amp;#34;&amp;gt;:&amp;lt;/span&amp;gt;
protoc --proto_path&amp;lt;span style=&amp;#34;color:#f92672&amp;#34;&amp;gt;=&amp;lt;/span&amp;gt;. --go_out&amp;lt;span style=&amp;#34;color:#f92672&amp;#34;&amp;gt;=&amp;lt;/span&amp;gt;. --micro_out&amp;lt;span style=&amp;#34;color:#f92672&amp;#34;&amp;gt;=&amp;lt;/span&amp;gt;. config/config.proto
ls config/*.pb.go | xargs -n1 -IX bash -c &amp;lt;span style=&amp;#34;color:#e6db74&amp;#34;&amp;gt;&amp;amp;#39;sed s/,omitempty// X &amp;amp;gt; X.tmp &amp;amp;amp;&amp;amp;amp; mv X{.tmp,}&amp;amp;#39;&amp;lt;/span&amp;gt;
&amp;lt;/code&amp;gt;&amp;lt;/pre&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;p&amp;gt;proto 目标的第一个命令是调用 protoc 根据 config/config.proto 生成 pb.go 文件；&amp;lt;/p&amp;gt;
&amp;lt;p&amp;gt;第二行命令就是将 config/*.pb.go 中的 &amp;lt;code&amp;gt;omitempty&amp;lt;/code&amp;gt; 删除。&amp;lt;/p&amp;gt;
&amp;lt;div class=&amp;#34;highlight&amp;#34;&amp;gt;&amp;lt;pre style=&amp;#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&amp;#34;&amp;gt;&amp;lt;code class=&amp;#34;language-go&amp;#34; data-lang=&amp;#34;go&amp;#34;&amp;gt;&amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;type&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;Message&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;struct&amp;lt;/span&amp;gt; {
&amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;Header&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;map&amp;lt;/span&amp;gt;[&amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;string&amp;lt;/span&amp;gt;]&amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;string&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#e6db74&amp;#34;&amp;gt;`protobuf:&amp;amp;#34;bytes,1,rep,name=header,proto3&amp;amp;#34; json:&amp;amp;#34;header&amp;amp;#34; protobuf_key:&amp;amp;#34;bytes,1,opt,name=key,proto3&amp;amp;#34; protobuf_val:&amp;amp;#34;bytes,2,opt,name=value,proto3&amp;amp;#34;`&amp;lt;/span&amp;gt;
&amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;Body&amp;lt;/span&amp;gt; []&amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;byte&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#e6db74&amp;#34;&amp;gt;`protobuf:&amp;amp;#34;bytes,2,opt,name=body,proto3&amp;amp;#34; json:&amp;amp;#34;body&amp;amp;#34;`&amp;lt;/span&amp;gt;
&amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;XXX_NoUnkeyedLiteral&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;struct&amp;lt;/span&amp;gt;{} &amp;lt;span style=&amp;#34;color:#e6db74&amp;#34;&amp;gt;`json:&amp;amp;#34;-&amp;amp;#34;`&amp;lt;/span&amp;gt;
&amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;XXX_unrecognized&amp;lt;/span&amp;gt; []&amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;byte&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#e6db74&amp;#34;&amp;gt;`json:&amp;amp;#34;-&amp;amp;#34;`&amp;lt;/span&amp;gt;
&amp;lt;span style=&amp;#34;color:#a6e22e&amp;#34;&amp;gt;XXX_sizecache&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#66d9ef&amp;#34;&amp;gt;int32&amp;lt;/span&amp;gt; &amp;lt;span style=&amp;#34;color:#e6db74&amp;#34;&amp;gt;`json:&amp;amp;#34;-&amp;amp;#34;`&amp;lt;/span&amp;gt;
}
&amp;lt;/code&amp;gt;&amp;lt;/pre&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;p&amp;gt;使用时，根据需要修改 &amp;lt;code&amp;gt;config/config.proto&amp;lt;/code&amp;gt; 和 &amp;lt;code&amp;gt;config/*.pb.go&amp;lt;/code&amp;gt; 即可。&amp;lt;/p&amp;gt;</description></item></channel></rss>