<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>徐旭 的博客</title><meta name=description content><meta name=author content="徐旭"><link rel=canonical href=https://allenxuxu.github.io/><link crossorigin=anonymous href=/assets/css/stylesheet.min.04512c372388e08b5118f5b117b2d3efef4ddae52017e16085c8d8d4e361c43d.css integrity="sha256-BFEsNyOI4ItRGPWxF7LT7+9N2uUgF+FghcjY1ONhxD0=" rel="preload stylesheet" as=style><link rel=icon href=https://allenxuxu.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://allenxuxu.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://allenxuxu.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://allenxuxu.github.io/apple-touch-icon.png><link rel=mask-icon href=https://allenxuxu.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.81.0"><link rel=alternate type=application/rss+xml href=https://allenxuxu.github.io/index.xml><link rel=alternate type=application/json href=https://allenxuxu.github.io/index.json><meta property="og:title" content="徐旭 的博客"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://allenxuxu.github.io/"><meta name=twitter:card content="summary"><meta name=twitter:title content="徐旭 的博客"><meta name=twitter:description content><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"徐旭 的博客","url":"https://allenxuxu.github.io/","description":"","thumbnailUrl":"https://allenxuxu.github.io/favicon.ico","sameAs":["https://github.com/Allenxuxu","index.xml"]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://allenxuxu.github.io/ accesskey=h title="徐旭 的博客 (Alt + H)">徐旭 的博客</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://allenxuxu.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://allenxuxu.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://allenxuxu.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://allenxuxu.github.io/about/ title="About Me"><span>About Me</span></a></li></ul></nav></header><main class=main><article class="first-entry home-info"><header class=entry-header><h1>时光很匆忙 留下一些痕迹</h1></header><section class=entry-content><p>礼法岂是为吾辈而设</p></section><footer class=entry-footer><div class=social-icons><a href=https://github.com/Allenxuxu target=_blank rel="noopener noreferrer me" title=Github><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=index.xml target=_blank rel="noopener noreferrer me" title="Rs s"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div></footer></article><article class=post-entry><header class=entry-header><h2>Go1.16 embed 和 Vue</h2></header><section class=entry-content><p>vue 相关代码： https://github.com/Allenxuxu/ginvue
先全局安装下 vue cli 并创建一个 demo 项目
npm install -g @vue/cli vue create web 然后我们进入 web 目录，修改生成的 package.json 文件调整一下 build 生成的静态文件目录。
–dest 是指定输出的目录
**–no-clean 是让他不要每次覆盖我们的目录，因为后面我们会放一个 go 文件到那个目录。 **
"build": "vue-cli-service build --no-clean --dest ../static", 再新增一个 vue.config.js 文件来修改下 , 这里将 production 的 publicPath 修改成带一个前缀 /ui/ , 这里主要就是为了后面我们的go 代码路由设置方便，所有的前端静态文件请求都带上 /ui 前缀，和后端 API 接口带 /api 前缀区分。
module.exports = { publicPath: process.env.NODE_ENV === 'production' ? '/ui/' : '/' } 最后我们再 web 目录运行 npm run build，会生成一个 static 目录（也就是我们修改的 package....</p></section><footer class=entry-footer>April 20, 2021&nbsp;·&nbsp;2 min&nbsp;·&nbsp;徐旭</footer><a class=entry-link aria-label="post link to Go1.16 embed 和 Vue" href=https://allenxuxu.github.io/posts/practice/gin-vue/></a></article><article class=post-entry><header class=entry-header><h2>Golang slice map channel 小技巧</h2></header><section class=entry-content><p>Slice vs Array Slice 和 Array 是不同的类型 package main func main() { s := make([]int, 100) printSlice(s) var a [100]int printArray(a) } func printSlice(s []int) { println(len(s)) // 100 println(cap(s)) // 100 } func printArray(a [100]int) { println(len(a)) // 100 println(cap(a)) // 100 } Slice 结构体
type slice struct { array unsafe.Pointer len int cap int } 下面的汇编表明，当类型是 slice 的时候，打印 len 或者 cap 的时候，会去栈上取数据:
MOVQ 0x28(SP), AX MOVQ AX, 0x8(SP) CALL 0xbfc [1:5]R_CALL:runtime....</p></section><footer class=entry-footer>April 17, 2021&nbsp;·&nbsp;3 min&nbsp;·&nbsp;徐旭</footer><a class=entry-link aria-label="post link to Golang slice map channel 小技巧" href=https://allenxuxu.github.io/posts/go/go-slice-map-channel/></a></article><article class=post-entry><header class=entry-header><h2>RocketMQ 设计与理解</h2></header><section class=entry-content><p>整体架构 RocketMQ 主要由 Producer、Broker、Consumer、Name Server 四个部分组成。
其中Producer 负责生产消息，Consumer 负责消费消息，Broker 负责存储消息，Name server 充当路由消息的提供者。
每个 Broker 可以存储多个Topic的消息，每个Topic的消息也可以分片存储于不同的 Broker。Message Queue 用于存储消息的物理地址，每个Topic中的消息地址存储于多个 Message Queue 中。
Topic Topic 是一种逻辑上的分区，是同一类消息的集合，每一个消息只能属于一个 Topic ，是RocketMQ进行消息订阅的基本单位。
每个 topic 会被分成很多 Messsage Queue ，和 Kafka 中的 Partition 概念一样，topic 的数据被分布在不同的 Message Queue 中。
在业务增长，消息量增大时，可以增大 topic 的 Message Queue，这样可以将压力分摊到更多的 broker 上。因为 Producer 可以发送消息的时候可以通过指定的算法，将消息均匀的发送到每个 Message Queue。
NameServer 生产者或消费者能够通过 Name Server查找各 Topic 相应的Broker IP 列表。 Name Server 可以多机部署变成一个集群保证高可用，但这些机器间彼此并不通信，也就是说三者的元数据舍弃了强一致性。
每一个 broker 启动时会向全部的 Name server 机器注册心跳，心跳里包含自己机器上 Topic 的拓扑信息，之后每隔 30s 更新一次，然后生产者和消费者启动的时候任选一台 Name Server 机器拉取所需的 Topic 的路由信息缓存在本地内存中，之后每隔 30s 定时从远端拉取更新本地缓存。...</p></section><footer class=entry-footer>April 5, 2021&nbsp;·&nbsp;2 min&nbsp;·&nbsp;徐旭</footer><a class=entry-link aria-label="post link to RocketMQ 设计与理解" href=https://allenxuxu.github.io/posts/mq/rocketmq/></a></article><article class=post-entry><header class=entry-header><h2>git 修改已经 commit 的邮箱信息</h2></header><section class=entry-content><p>开发过程中，经常会出现提交邮箱搞错的情况。在公司项目中错误提交了自己的 GitHub 邮箱，或者在开源项目中提交了公司邮箱。
下面记录一下补救措施。
先修改 .git/config 或者 修改全局的，修改成你需要的邮箱信息。
[user] email = name@qq.com name = yourname git log 找到要修改的那一条 commit，复制要修改的commit 的前一条 commit 的哈希值。
git rebase -i {{刚刚复制的哈希值}}
然后后会出现一个 vim 打开的文本，将需要修改的 commit 信息前面的 pick 文本改成 edit，保存退出。
修改邮箱信息
git commit --amend --author="name &lt;name@qq.com>" --no-edit
这时候查看 git log 信息，发现邮箱已经更改了。
强制 push 到远程（注意风险）
git push -f origin HEAD:master
done！</p></section><footer class=entry-footer>September 10, 2020&nbsp;·&nbsp;1 min&nbsp;·&nbsp;徐旭</footer><a class=entry-link aria-label="post link to git 修改已经 commit 的邮箱信息" href=https://allenxuxu.github.io/posts/practice/git-amend/></a></article><article class=post-entry><header class=entry-header><h2>golang protobuf 字段为零值时 json 序列化忽略问题</h2></header><section class=entry-content><p>protoc 编译生成的 pb.go 文件，默认情况下 tag 中会设置 json 忽略零值的返回属性 omitempty。
type Message struct { Header map[string]string `protobuf:"bytes,1,rep,name=header,proto3" json:"header,omitempty" protobuf_key:"bytes,1,opt,name=key,proto3" protobuf_val:"bytes,2,opt,name=value,proto3"` Body []byte `protobuf:"bytes,2,opt,name=body,proto3" json:"body,omitempty"` XXX_NoUnkeyedLiteral struct{} `json:"-"` XXX_unrecognized []byte `json:"-"` XXX_sizecache int32 `json:"-"` } 一个比较 hack 的方式，是在 pb.go 文件生成后，手动去删掉 omitempty 。每次手动去删除，比较麻烦且容易出错，下面提供一个 Makefile ，每次生成 pb.go 的时候就去删除 omitempty 。
proto: protoc --proto_path=. --go_out=. --micro_out=. config/config.proto ls config/*.pb.go | xargs -n1 -IX bash -c 'sed s/,omitempty// X > X.tmp && mv X{.tmp,}' proto 目标的第一个命令是调用 protoc 根据 config/config....</p></section><footer class=entry-footer>June 2, 2020&nbsp;·&nbsp;1 min&nbsp;·&nbsp;徐旭</footer><a class=entry-link aria-label="post link to golang protobuf 字段为零值时 json 序列化忽略问题" href=https://allenxuxu.github.io/posts/practice/protobuf-json/></a></article><article class=post-entry><header class=entry-header><h2>go chan 实用示例</h2></header><section class=entry-content><p>尝试发送 select { case c &lt;- struct{}{}: default: fmt.Println("chan 已满，发送不成功") } 尝试接收 select { case v := &lt;- c: default: fmt.Println("chan 中没有信息，接收不成功") } 标准编译器对尝试发送和尝试接收代码块做了特别的优化，使得它们的执行效率比多 case分支的普通 select代码块执行效率高得多。
无阻塞的检查一个 chan 是否关闭 假设我们可以保证没有任何协程会向一个通道发送数据，则我们可以使用下面的代码来（并发安全地）检查此通道是否已经关闭，此检查不会阻塞当前协程。
func IsClosed(c chan struct{}) bool { select { case &lt;-c: return true default: } return false } 最快回应 package main import ( "fmt" "math/rand" "time" ) func source(c chan&lt;- int, id int) { rb := rand....</p></section><footer class=entry-footer>May 30, 2020&nbsp;·&nbsp;1 min&nbsp;·&nbsp;徐旭</footer><a class=entry-link aria-label="post link to go chan 实用示例" href=https://allenxuxu.github.io/posts/go/go-channel/></a></article><article class=post-entry><header class=entry-header><h2>二叉堆与堆排序</h2></header><section class=entry-content><p>二叉堆是一组能够用堆有序的完全二叉树排序的元素，一般用数组来存储。
大顶堆， 每个结点的值都大于或等于其左右孩子结点的值，其顶部为最大值。
小顶堆，每个结点的值都小于或等于其左右孩子结点的值，其顶部为最小值。
二叉堆 性质 根节点在数组中的位置是 1 左边子节点 2i 右子节点 2i+1 父节点 i / 2 最后一个非叶子节点为 len / 2 根节点在数组中的位置是 0 左子节点 2i + 1 右边子节点 2i+ 2 父节点的下标是 (i − 1) / 2 最后一个非叶子节点为 len / 2 - 1 图片来自知乎
实现 构造二叉堆 找到最后一个非叶子节点 ( len / 2 或者 len / 2 - 1） 从最后一个非叶子节点下标索引开始递减，逐个下沉 插入节点 在数组的最末尾插入新节点 将最后一个节点上浮，时间复杂度为O(log n) 比较当前节点与父节点 不满足 堆性质* *则交换 删除根节点 删除根节点用于堆排序...</p></section><footer class=entry-footer>May 30, 2020&nbsp;·&nbsp;2 min&nbsp;·&nbsp;徐旭</footer><a class=entry-link aria-label="post link to 二叉堆与堆排序" href=https://allenxuxu.github.io/posts/algorithm/heap/></a></article><article class=post-entry><header class=entry-header><h2>二叉树的遍历模版（递归，迭代）</h2></header><section class=entry-content><p>图片来自 leetcode
深度优先遍历（dfs） 前序遍历 中序遍历 后序遍历 广度优先遍历（bfs） type TreeNode struct { Val int Left *TreeNode Right *TreeNode } 深度优先遍历 递归 递归版本，代码比较简单，只需改变 append 数据的位置即可。
前序遍历 func preorderTraversal(root *TreeNode) []int { var ret []int helper(root, &ret) return ret } func helper(root *TreeNode, data *[]int) { if root == nil { return } *data = append(*data, root.Val) helper(root.Left, data) helper(root.Right, data) } 中序遍历 func inorderTraversal(root *TreeNode) []int { var ret []int helper(root, &ret) return ret } func helper(root *TreeNode, data *[]int) { if root == nil { return } helper(root....</p></section><footer class=entry-footer>April 26, 2020&nbsp;·&nbsp;3 min&nbsp;·&nbsp;徐旭</footer><a class=entry-link aria-label="post link to 二叉树的遍历模版（递归，迭代）" href=https://allenxuxu.github.io/posts/algorithm/tree-traversal/></a></article><article class=post-entry><header class=entry-header><h2>Github Actions 配置 CI/CD 自动发布 docker 镜像</h2></header><section class=entry-content><p>Github Actions 是 Github 内置的 CI/CD 工具，现在已经对所有的开源项目免费开放了。
本文主要记录使用 Github Actions 实践 CI/CD 的一些配置。
功能目标 代码静态检查 代码单元测试 release/tag 时自动 build 镜像并推送到 docker hub 项目 Dockerfile 和 Makefile 项目主要目录
. ├── LICENSE ├── Makefile ├── README.md ├── config-srv │ ├── Makefile │ └── main.go ├── deployments │ ├── docker │ │ ├── config-srv │ │ │ └── Dockerfile ├── go.mod ├── go.sum config-srv 目录：服务代码 deployments 目录：所有服务的 Dockerfile Makefile 顶层 Makefile：build Docker 镜像 我们先看下顶层的 Makefile...</p></section><footer class=entry-footer>April 2, 2020&nbsp;·&nbsp;3 min&nbsp;·&nbsp;徐旭</footer><a class=entry-link aria-label="post link to Github Actions 配置 CI/CD 自动发布 docker 镜像" href=https://allenxuxu.github.io/posts/practice/github-action-docker/></a></article><article class=post-entry><header class=entry-header><h2>go-micro 动态加载插件源码分析</h2></header><section class=entry-content><p>go-micro 框架支持动态加载插件，无需修改代码。
源码分析 启动服务前，设定 MICRO_PLUGIN 环境变量指定动态库 .so 文件路径，支持多个插件，逗号分割。程序启动前会读取 MICRO_PLUGIN 环境变量，并完成插件设定。
下面是其内部实现：
go-micro/service.go
func (s *service) Init(opts ...Option) { ... // setup the plugins for _, p := range strings.Split(os.Getenv("MICRO_PLUGIN"), ",") { if len(p) == 0 { continue } // 加载 .so 文件 c, err := plugin.Load(p) if err != nil { logger.Fatal(err) } // go-micro 初始化插件 if err := plugin.Init(c); err != nil { logger.Fatal(err) } } 从上面的代码可以看出，service 初始化化的时候，读取 MICRO_PLUGIN 环境变量中指定的 ....</p></section><footer class=entry-footer>March 28, 2020&nbsp;·&nbsp;5 min&nbsp;·&nbsp;徐旭</footer><a class=entry-link aria-label="post link to go-micro 动态加载插件源码分析" href=https://allenxuxu.github.io/posts/go-micro/go-micro-plugin/></a></article><footer class=page-footer><nav class=pagination><a class=next href=https://allenxuxu.github.io/page/2/>Next Page »</a></nav></footer></main><footer class=footer><span>&copy; 2021 <a href=https://allenxuxu.github.io/>徐旭 的博客</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>